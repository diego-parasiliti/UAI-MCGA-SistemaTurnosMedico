@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Datos adicional de afiliado</h2>
<h5>@ViewBag.NombreAfiliado</h5>
<hr class="hrSinMarginTop" />
@Html.Hidden("AfiliadoId", (string)ViewBag.AfiliadoLogueadoId)

<div class="form-horizontal content-personalizado">
    <div class="row marginUnset">
        <div class="col-lg-12 col-md-12 col-sm-12">
            <div class="float-lg-right float-md-right float-sm-none">
                <div class="form-group">
                    <a id="agregar" title="Agregar dato adicional" class="btn btn-sm btn-primary text-white" onclick="AgregarDatoAdicional();">
                        <i class="fa fa-plus-circle"></i>
                        <span>Agregar</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row marginUnset">
        <div class="col-12">
            <div class="table-responsive">
                <div id="tableDatoAdicional">
                    <table class="table table-sm table-light table-bordered">
                        <thead class="thead-light">
                            <tr>
                                <th>
                                    Tipo
                                </th>
                                <th>
                                    Descripcion
                                </th>
                                <th>
                                    Valor
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td rowspan="5">
                                    Tipo
                                </td>
                                <td>
                                    A
                                </td>
                                <td>
                                    1
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    B
                                </td>
                                <td>
                                    2
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    C
                                </td>
                                <td>
                                    3
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    D
                                </td>
                                <td>
                                    4
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    E
                                </td>
                                <td>
                                    5
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="agregarDatoAdicional">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-light">
                <h4 class="modal-title">Nuevo dato adicional</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <div class="form-group">
                            @Html.Label("Tipo de dato", htmlAttributes: new { @class = "control-label col-md-12" })
                            <div class="col-md-6">
                                <select id="cboTipoKeyId" class="form-control inputSinMaxWidth" onchange="CargarFormNuevoDatoAdicional();"></select>
                                @Html.Hidden("TipoKeyId")
                                @Html.Hidden("ListControlId")
                            </div>
                        </div>
                    </div>
                </div>
                <hr class="hrSinMarginTop" />
                <div class="row" id="rowDatoAdicional">

                </div>
            </div>
            <div class="modal-footer">
                <a class="btn btn-secondary text-white" title="Cerrar" data-dismiss="modal">
                    <i class="fa fa-close"></i>
                    Cerrar
                </a>
                <a class="btn btn-success text-white" title="Guardar" onclick="GuardarDatoAdicional();">
                    <i class="fa fa-check-circle"></i>
                    Guardar
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        $(document).ready(function () {

        });

        function AgregarDatoAdicional() {
              $.ajax({
                url: '@Url.Action("GetTipoKey", "DatoAdicionalAfiliado")',
                datatype: "json",
                async:false,
                success: function (data) {
                    var datos = data;
                    $("#cboTipoKeyId").empty();
                    for (var i = 0; i < datos.length; i++) {
                        $("#cboTipoKeyId").append($('<option>', {
                            value: datos[i].Id,
                            text: datos[i].Descripcion
                        }));
                    }
                    CargarFormNuevoDatoAdicional();
                }
            });
            $('#agregarDatoAdicional').modal('show');
        }

        function CargarFormNuevoDatoAdicional() {
            $('#TipoKeyId').val($('#cboTipoKeyId').val());
            $('#rowDatoAdicional').empty();
            $.ajax({
                url: '@Url.Action("GetCamposByTipoKey", "DatoAdicionalAfiliado")',
                datatype: "json",
                data: { tipoKeyId: $("#TipoKeyId").val() },
                async: false,
                success: function (data) {
                    var datos = data;
                    for (var i = 0; i < datos.length; i++) {
                        var div_col_principal = document.createElement('div');
                        var div_formgroup = document.createElement('div');
                        var label = document.createElement('label');
                        var div_col_control = document.createElement('div');
                        div_col_principal.className = "col-sm-12 col-md-6 col-lg-6";
                        div_formgroup.className = "form-group";
                        label.setAttribute("id", 'lbl_' + datos[i].ControlId);
                        label.setAttribute("name", 'lbl_' + datos[i].ControlId);
                        label.setAttribute("class", "col-md-6 control-label");
                        label.innerHTML = datos[i].LabelControl;
                        div_col_control.className = "col-sm-12 col-md-12 col-lg-12";

                        switch (datos[i].TipoControl) {
                            case "Fecha":
                                var campo = document.createElement('input');
                                campo.className = "form-control inputSinMaxWidth";
                                campo.setAttribute("id", datos[i].ControlId);
                                campo.setAttribute("name", datos[i].ControlId);
                                campo.type = "date";
                                div_col_control.appendChild(campo);
                                break;
                            case "TextBox":
                                var campo = document.createElement('input');
                                campo.className = "form-control inputSinMaxWidth";
                                campo.setAttribute("id", datos[i].ControlId);
                                campo.setAttribute("name", datos[i].ControlId);
                                campo.type = "text";
                                div_col_control.appendChild(campo);
                                break;
                            case "CheckBox":
                                var campo = document.createElement('input');
                                campo.setAttribute("id", datos[i].ControlId);
                                campo.setAttribute("name", datos[i].ControlId);
                                campo.type = "checkbox";
                                campo.setAttribute("style", "margin-top:10px;");
                                div_col_control.appendChild(campo);
                                break;
                            case "DropDownList":
                                var campo = document.createElement('select');
                                campo.className = "form-control inputSinMaxWidth";
                                campo.setAttribute("id", datos[i].ControlId);
                                campo.setAttribute("name", datos[i].ControlId);
                                var fragment = document.createDocumentFragment();
                                if (datos[i].DatosAdicionales != "") {
                                    var json = JSON.parse(datos[i].DatosAdicionales);
                                    for (var x = 0; x < json.length; x++) {
                                        var opt = document.createElement('option');
                                        opt.innerHTML = json[x];
                                        opt.value = json[x];
                                        fragment.appendChild(opt);
                                    }
                                }
                                campo.appendChild(fragment);
                                div_col_control.appendChild(campo);
                                break;
                        }
                        div_formgroup.appendChild(label);
                        div_formgroup.appendChild(div_col_control);
                        div_col_principal.appendChild(div_formgroup);
                        $('#rowDatoAdicional').append(div_col_principal);

                        
                        if (i == (datos.length -1)) 
                            $('#ListControlId').val($('#ListControlId').val() + datos[i].ControlId);
                        else
                            $('#ListControlId').val($('#ListControlId').val() + datos[i].ControlId + ',');
                        
                        
                    }
                }
            });
        }


        function GuardarDatoAdicional() {
            var lisControlId = $('#ListControlId').val().split(",");
            var listData = new Array();
            var listData = new Array();
            var data = { };
            for (var i = 0; i < lisControlId.length; i++) {
                debugger;
                var textLabel = $('#lbl_' + lisControlId[i] + '').text();
                data[textLabel] = $('#' + lisControlId[i] + '').val();
            }
            debugger;
            var jsonData = JSON.stringify({
                'AfiliadoId': $("#AfiliadoId").val(),
                'TipoKeyId': $("#TipoKeyId").val(),
                'JsonData': JSON.stringify(data)
            });
            
            $.ajax({
                url: '@Url.Action("GuardarDatoAdicionalAfiliad", "DatoAdicionalAfiliado")',
                type: 'POST',
                contentType: 'application/json',
                dataType: "json",
                data: jsonData ,
                success: function (response) {
                    $('#agregarDatoAdicional').modal('hide');
                },
                failure: function (response) {
                    alert(response.responseText);
                },
                error: function (response) {
                    alert(response.responseText);
                }
            });
        }

    </script>
}

